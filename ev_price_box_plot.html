<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EV Manufacturer Type Distribution</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    .bar { opacity: 0.8; }
    .axis-label { font-size: 12px; font-weight: bold; }
    .legend { font-size: 12px; }
  </style>
</head>
<body>
  <h2 style="text-align: center;">EV Manufacturer Type Distribution (BEV vs PHEV)</h2>
  <script>
    // dimensions
    const width = 800, height = 400, margin = { top: 20, right: 30, bottom: 100, left: 60 };

    // create SVG
    const svg = d3.select("body")
                  .append("svg")
                  .attr("width", width + margin.left + margin.right)
                  .attr("height", height + margin.top + margin.bottom)
                  .append("g")
                  .attr("transform", `translate(${margin.left},${margin.top})`);

    // load data
    d3.csv("Electric_Vehicle_Data.csv").then(data => {
      // preprocess and group the data by Make and Type (BEV, PHEV)
      const groupedData = d3.rollups(
        data,
        group => d3.sum(group, d => 1), // Count vehicles
        d => d.Make, // Group by manufacturer
        d => d.Type // Group by BEV or PHEV
      );

      //format data for stacked bar chart
      const formattedData = groupedData.map(([Make, types]) => {
        const bevCount = types.find(d => d[0] === "BEV") ? types.find(d => d[0] === "BEV")[1] : 0;
        const phevCount = types.find(d => d[0] === "PHEV") ? types.find(d => d[0] === "PHEV")[1] : 0;
        return { Make, BEV: bevCount, PHEV: phevCount };
      });

      // scales
      const x = d3.scaleBand()
                  .domain(formattedData.map(d => d.Make))
                  .range([0, width])
                  .padding(0.2);

      const y = d3.scaleLinear()
                  .domain([0, d3.max(formattedData, d => d.BEV + d.PHEV)])
                  .range([height, 0]);

      //axes
      svg.append("g")
         .call(d3.axisLeft(y).ticks(10))
         .selectAll("text")
         .attr("class", "axis-label");

      svg.append("g")
         .attr("transform", `translate(0,${height})`)
         .call(d3.axisBottom(x))
         .selectAll("text")
         .attr("transform", "rotate(-45)")
         .style("text-anchor", "end")
         .attr("class", "axis-label");

      //add stacked bars
      svg.selectAll(".bar")
         .data(formattedData)
         .enter()
         .append("g")
         .attr("transform", d => `translate(${x(d.Make)}, 0)`)
         .selectAll("rect")
         .data(d => [
            { type: "BEV", value: d.BEV },
            { type: "PHEV", value: d.PHEV }
         ])
         .enter()
         .append("rect")
         .attr("class", "bar")
         .attr("x", 0)
         .attr("y", d => y(d.value + (d.type === "BEV" ? 0 : d.value))) // Stack BEV on top of PHEV
         .attr("width", x.bandwidth())
         .attr("height", d => height - y(d.value))
         .attr("fill", d => d.type === "BEV" ? "steelblue" : "orange");

      //legend
      svg.append("circle").attr("cx", 20).attr("cy", height + 30).attr("r", 6).style("fill", "steelblue");
      svg.append("text").attr("x", 35).attr("y", height + 30).text("BEV").attr("class", "legend");

      svg.append("circle").attr("cx", 20).attr("cy", height + 50).attr("r", 6).style("fill", "orange");
      svg.append("text").attr("x", 35).attr("y", height + 50).text("PHEV").attr("class", "legend");
      
      //axis labels
      svg.append("text")
         .attr("x", width / 2)
         .attr("y", height + margin.bottom - 40)
         .attr("text-anchor", "middle")
         .attr("class", "axis-label")
         .text("Manufacturer");

      svg.append("text")
         .attr("x", -height / 2)
         .attr("y", -margin.left + 15)
         .attr("text-anchor", "middle")
         .attr("transform", "rotate(-90)")
         .attr("class", "axis-label")
         .text("Vehicle Count");
    });
  </script>
</body>
</html>
